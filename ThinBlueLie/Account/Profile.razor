@page "/Account/Profile"
@using System.Diagnostics
@using Syncfusion.Blazor.ProgressBar
@using Syncfusion.Blazor.Navigations
@using Microsoft.AspNetCore.Identity
@using DataAccessLibrary.UserModels
@using ThinBlueLie.Helper.Extensions
@using Syncfusion.Blazor.Grids
@using Syncfusion.Blazor.Buttons
@using static ThinBlueLie.Helper.Extensions.EnumExtensions
@using static DataAccessLibrary.Enums.PrivledgeEnum
@inherits ProfileBase
@inject UserManager<ApplicationUser> userManager
@attribute [Authorize]
<Title>Profile - Thin Blue Lie</Title>
<Meta Name="robots" Content="noindex" />

<style>
    ul {
        list-style-type: none;
    }

    li a {
        color: dimgray;
        font-size: 1rem;
    }

        li a:hover {
            color: black;
        }

    .e-delete:before {
        content: '/e773';
    }

    .e-edit:before {
        content: '/e690';
    }
</style>
<div class="mx-md-5 mt-3">
    <SfSidebar Width="160px" Animate="false" EnableGestures="false" Target=".main-content" MediaQuery="(min-width:600px)">
        <ChildContent>
            <div class="main-menu nav-with-bar mt-1">
                <ul class="mt-3">
                    <li>
                        <NavLink class="nav-link" href="/Account/Profile">Profile</NavLink>
                    </li>
                    <li>
                        <NavLink class="nav-link" href="/Account/ReviewEdits">Review Edits</NavLink>
                    </li>
                    @*<li>
                        <NavLink class="nav-link" href="/Account/Reputation">Reputation</NavLink>
                    </li>*@
                </ul>
            </div>
        </ChildContent>
    </SfSidebar>
    <div class="main-content">
        <div class="sidebar-content pl-2">
            <div class="d-flex justify-content-between border-bottom">
                <div class="pl-4 d-flex align-items-end" style="font-size:1.2rem;">
                    @userState.User.Identity.Name                  
                </div>
            </div>
            <div class="border-bottom row px-3 pt-2">              
                @if (Loading == false)
                {
                <div class="col-6">
                    <h5><a href="/About/Reputation">Reputation</a></h5>
                    <h6>Granted Perms</h6>
                    <ul>
                        @foreach (Privledges privledge in Enum.GetValues(typeof(Privledges)))
                        {
                            @if (User.Reputation > (int)privledge)
                            {
                                <li>
                                    @GetEnumDisplayName(privledge)
                                </li>
                            }
                        }
                    </ul>
                </div>
                    <div class="col-6">
                        <div>
                            <div>
                                Total Reputation: @User.Reputation
                            </div>
                            <div>
                                Next Privledge: @(GetEnumDisplayName(User.NextPrivledge()))
                            </div>
                            <SfProgressBar @ref="Reputation" Type="ProgressType.Linear" Height="35"
                                           ID="Percentage"
                                           TrackThickness="24"
                                           ProgressThickness="24" Role="ModeType.Success"
                                           ShowProgressValue="true"
                                           Value="User.Reputation - (int)User.CurrentPrivledge()"
                                           Minimum="0"
                                           Maximum="((int)User.NextPrivledge() - (int)User.CurrentPrivledge())"
                                           Theme="@ProgressTheme.Bootstrap4">
                                <ProgressBarLabelStyle Text="@((User.Reputation - (int)User.CurrentPrivledge()) + "/" + ((int)User.NextPrivledge() - (int)User.CurrentPrivledge()))" 
                                                       TextAlignment="TextAlignmentType.Center" Color="#FFFFFF" />
                                <ProgressBarAnimation Enable="true" Duration="2000" Delay="0" />
                            </SfProgressBar>
                        </div>
                        <div>
                            Member Since: @User.DateJoined.ToString("D")
                        </div>
                    </div>
                }
                else
                {
                    <h6>Loading...</h6>
                }
            </div>
            <div class="row px-3 pt-2">
                <div class="col-lg-3 col-6">
                    <p>
                        <b>Submissions: </b>@profile.Submissions?.Count()
                    </p>
                    <p>
                        <b>Edits Accepted: </b>@profile.AcceptedEdits
                    </p>
                </div>
                <div lass="col-lg-3 col-6">
                    <p>
                        <b>Flags: </b>@profile.Flags
                    </p>
                    <p>
                        <b>Votes Cast: </b>@profile.AcceptedEdits
                    </p>
                </div>
            </div>
            <div class="d-flex">
                <SfGrid DataSource="@profile.Submissions" AllowSelection="false" AllowFiltering="true"
                        EnableVirtualization="true" Height="550" AllowResizing="true" >
                    <GridFilterSettings Type="Syncfusion.Blazor.Grids.FilterType.Excel"></GridFilterSettings>
                    <GridPageSettings PageCount="5"></GridPageSettings>
                    <GridColumns>
                        <GridColumn Field=@nameof(Timelineinfo.Timestamp) HeaderText="Date Posted" Format="d" Width="50"></GridColumn>
                        <GridColumn Field=@nameof(Timelineinfo.Date) HeaderText="Event's Date" Width="50" Format="d"></GridColumn>
                        <GridColumn Field=@nameof(Timelineinfo.Title) HeaderText="Title" Width="120"></GridColumn>
                        <GridColumn Field=@nameof(Timelineinfo.Owner) HeaderText="Owner" Width="50">
                            <Template>
                                @{
                                    var owner = (context as int?);
                                    <span>@(owner != 0? "You" : "Community") </span>
                                }
                            </Template>
                        </GridColumn>
                        <GridColumn HeaderText="Actions" Width="75">
                            <Template>
                                @{
                                    var Event = (context as Timelineinfo);
                                    <SfButton IsPrimary="true" CssClass="e-outline e-danger" IconCss="e-icons e-delete"></SfButton>
                                    <SfButton IsPrimary="true" CssClass="e-outline e-info" IconCss="e-icons e-edit">
                                        <a href="Edit?id=@Event?.IdTimelineinfo"></a>
                                    </SfButton>
                                }
                            </Template>
                        </GridColumn>
                        <GridColumn Field=@nameof(Timelineinfo.Updated) HeaderText="Last Updated" Width="50" Format="d"></GridColumn>
                    </GridColumns>
                </SfGrid>
            </div>
        </div>
    </div>
</div>
@code {
    SfProgressBar Reputation;
    bool Loading;
    protected override async Task OnInitializedAsync()
    {
        Loading = true;
        userState = await AuthState;
        User = await userManager.GetUserAsync(userState.User);
        Loading = false;
        await GetProfile();
    }
}
